#!/usr/bin/env bash
set -euo pipefail

# 1. Content-based regex patterns (search anywhere in file)
CONTENT_BLOCKED_PATTERNS=(
  'console\.log'
  'TODO'
  'FIXME'
  'debugger'
)

# 2. Exact disallowed ignore rules
EXACT_BLOCKED_LINES=(
  '**/*.ts'
)

# 3. Glob-style disallowed ignore rules
GLOB_BLOCKED_PATTERNS=(
  '**/*.ts*'
)

# Files to scan
FILE_REGEX='(\.(js|ts|tsx|py|sh)$|(^|/)\.(git|cursor|copilot|gemini|ai)ignore$)'

FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "$FILE_REGEX" || true)
[ -z "$FILES" ] && exit 0

for file in $FILES; do
  staged_content="$(git show ":$file" || true)"

  # --- 1. Content-based regex checks ---
  for pattern in "${CONTENT_BLOCKED_PATTERNS[@]}"; do
    if printf '%s\n' "$staged_content" | grep -nE "$pattern" >/dev/null; then
      echo "❌ Commit blocked:"
      echo "   Content pattern '$pattern' found in $file"
      exit 1
    fi
  done

  # --- 2. Ignore-file semantic checks ---
  case "$file" in
    .*ignore)
      printf '%s\n' "$staged_content" | while IFS= read -r line; do
        # Skip comments and empty lines
        [ -z "$line" ] && continue
        case "$line" in \#*) continue ;; esac

        # Exact match
        for exact in "${EXACT_BLOCKED_LINES[@]}"; do
          if [ "$line" = "$exact" ]; then
            echo "❌ Commit blocked:"
            echo "   Exact disallowed ignore rule in $file: $line"
            exit 1
          fi
        done

        # Glob match
        for glob in "${GLOB_BLOCKED_PATTERNS[@]}"; do
          if [[ "$line" == $glob ]]; then
            echo "❌ Commit blocked:"
            echo "   Pattern disallowed ignore rule in $file: $line"
            exit 1
          fi
        done
      done
      ;;
  esac
done

exit 0
